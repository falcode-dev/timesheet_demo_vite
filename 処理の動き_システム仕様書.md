# タイムシートアプリケーション - 処理の動きとシステム仕様書

## 📋 概要
このドキュメントは、タイムシート管理アプリケーションの処理の動きを、プログラマーでない方でも理解できるように説明したものです。

## 🎯 アプリケーションの目的
- **作業時間の記録**: 従業員が作業した時間を記録・管理する
- **プロジェクト管理**: 複数のプロジェクト（WorkOrder）に分けて作業時間を管理
- **カレンダー表示**: 視覚的に作業時間を確認できる
- **データ保存**: Microsoft Dataverse（データベース）に作業時間データを保存

---

## 🏗️ システム全体の構造

### 1. アプリケーションの起動
```
ユーザーがブラウザでアプリにアクセス
↓
Reactアプリケーションが起動
↓
必要なデータ（プロジェクト一覧、設定値など）を取得
↓
カレンダー画面が表示される
```

### 2. 主要な画面構成
- **ヘッダー**: アプリタイトル、プロジェクト選択、アップロードボタン
- **メインエリア**: カレンダー表示（週/3日/1日の切り替え可能）
- **サイドバー**: お気に入りタスク一覧
- **フッター**: ユーザー一覧、お気に入りタスク管理ボタン

---

## 🔄 主要な処理の流れ

### 1. アプリケーション初期化処理

#### 1.1 データ取得
```
アプリ起動時
↓
以下のデータを並行して取得：
- プロジェクト一覧（WorkOrder）
- 設定値一覧（OptionSet）
- 作業時間データ（TimeEntry）
↓
データ取得完了後、画面表示
```

#### 1.2 環境判定
```
アプリは2つの環境で動作：
- ローカル環境: テスト用（ブラウザのローカルストレージを使用）
- Dataverse環境: 本番用（Microsoft Dataverseデータベースを使用）
```

### 2. カレンダー表示処理

#### 2.1 カレンダーの初期化
```
カレンダーコンポーネントが読み込まれる
↓
FullCalendarライブラリを使用してカレンダーを描画
↓
取得した作業時間データをイベントとして表示
↓
ユーザーが選択したプロジェクトのイベントを強調表示
```

#### 2.2 表示モード切り替え
```
ユーザーが「週」「3日」「1日」を選択
↓
カレンダーの表示範囲が変更される
↓
現在の日付が表示される
```

### 3. 作業時間記録処理

#### 3.1 新規作業時間の作成
```
ユーザーがカレンダーの空いている時間をクリック
↓
「作業時間入力モーダル」が開く
↓
以下の情報を入力：
- プロジェクト（WorkOrder）
- 開始日時・終了日時
- 作業内容（メインカテゴリ、時間カテゴリなど）
- 支払いタイプ
- タイムゾーン
- リソース（担当者）
- コメント
↓
「保存」ボタンをクリック
↓
データがDataverseまたはローカルストレージに保存される
↓
カレンダーが更新される
```

#### 3.2 既存作業時間の編集
```
ユーザーがカレンダーの作業時間イベントをクリック
↓
「作業時間編集モーダル」が開く
↓
既存の情報が自動入力される
↓
必要に応じて情報を修正
↓
「更新」ボタンをクリック
↓
データが更新される
```

#### 3.3 作業時間の削除
```
編集モーダルで「削除」ボタンをクリック
↓
削除確認ダイアログが表示される
↓
「削除」を確認
↓
データが削除される
↓
カレンダーからイベントが消える
```

#### 3.4 作業時間の複製
```
編集モーダルで「複製」ボタンをクリック
↓
現在のモーダルが閉じる
↓
新しいモーダルが開く（同じ情報が入力済み）
↓
必要に応じて情報を修正
↓
「保存」ボタンをクリック
↓
新しい作業時間が作成される
```

### 4. プロジェクト管理処理

#### 4.1 プロジェクト選択
```
ヘッダーのプロジェクト選択ドロップダウンをクリック
↓
利用可能なプロジェクト一覧が表示される
↓
プロジェクトを選択
↓
カレンダーに表示される作業時間が選択したプロジェクトのものに絞り込まれる
```

#### 4.2 全プロジェクト表示
```
「すべて」を選択
↓
すべてのプロジェクトの作業時間が表示される
```

### 5. お気に入りタスク管理処理

#### 5.1 お気に入りタスクの登録
```
フッターの「お気に入りタスク」ボタンをクリック
↓
お気に入りタスク管理モーダルが開く
↓
タスク名、サブカテゴリ、タスク名を入力
↓
「保存」ボタンをクリック
↓
お気に入りタスクが登録される
```

#### 5.2 お気に入りタスクの表示
```
サイドバーにお気に入りタスク一覧が表示される
↓
タスクをクリックすると、作業時間入力モーダルが開く
↓
タスク名が自動入力される
```

### 6. ユーザー管理処理

#### 6.1 許可ユーザーの管理
```
フッターの「ユーザー一覧」ボタンをクリック
↓
ユーザー一覧管理モーダルが開く
↓
許可するユーザーIDを入力・削除
↓
「保存」ボタンをクリック
↓
許可ユーザーリストが更新される
```

---

## 🔧 技術的な処理の詳細

### 1. データ取得処理

#### 1.1 React Queryによるデータ管理
```
アプリケーションはReact Queryライブラリを使用してデータを管理
↓
データの取得、キャッシュ、更新を自動化
↓
ネットワークエラー時の再試行も自動化
```

#### 1.2 APIクライアント
```
Dataverse環境では、専用のAPIクライアントを使用
↓
BaseClientクラスを継承した各エンティティ用クライアント
↓
型安全で拡張可能な設計
```

### 2. 状態管理

#### 2.1 Context APIによる状態共有
```
UserListContext: 許可ユーザー情報を管理
FavoriteTaskContext: お気に入りタスク情報を管理
↓
アプリ全体で状態を共有
```

#### 2.2 カスタムフックによる処理分離
```
useAppController: アプリ全体の状態とロジックを統括
useTimeEntryActions: 作業時間関連の操作を管理
useEvents: イベント（作業時間）の取得・更新を管理
↓
処理を機能ごとに分離して保守性を向上
```

### 3. 多言語対応

#### 3.1 i18nextによる国際化
```
日本語と英語の両方に対応
↓
ユーザーの言語設定に応じて表示を切り替え
↓
カレンダーの表示も言語に応じて変更
```

---

## 🚀 パフォーマンス最適化

### 1. データ取得の最適化
```
必要なデータのみを取得
↓
キャッシュ機能により重複取得を防止
↓
並行処理により高速化
```

### 2. UIの最適化
```
React.memoによる不要な再レンダリングを防止
↓
useMemoによる計算結果のキャッシュ
↓
効率的な状態更新
```

---

## 🔒 セキュリティとエラーハンドリング

### 1. データ検証
```
入力データの型チェック
↓
必須項目の検証
↓
日時の論理的な整合性チェック
```

### 2. エラー処理
```
ネットワークエラー時の再試行
↓
ユーザーフレンドリーなエラーメッセージ
↓
ログ出力による問題の追跡
```

---

## 📊 データフロー図

```
ユーザー操作
    ↓
UIコンポーネント
    ↓
カスタムフック
    ↓
APIクライアント
    ↓
Dataverse/ローカルストレージ
    ↓
データベース更新
    ↓
UI更新
```

---

## 🎨 ユーザーインターフェース

### 1. レスポンシブデザイン
```
デスクトップ、タブレット、スマートフォンに対応
↓
画面サイズに応じてレイアウトが自動調整
```

### 2. アクセシビリティ
```
キーボード操作に対応
↓
スクリーンリーダーに対応
↓
色のコントラストを考慮したデザイン
```

---

## 🔄 今後の拡張性

### 1. 新機能の追加
```
モジュラー設計により新機能を容易に追加可能
↓
既存の機能に影響を与えずに拡張
```

### 2. データベースの拡張
```
新しいエンティティの追加が容易
↓
既存のデータ構造を変更せずに機能追加
```

---

## 📝 まとめ

このタイムシートアプリケーションは、以下の特徴を持つ現代的なWebアプリケーションです：

1. **直感的な操作**: カレンダーをクリックするだけで作業時間を記録
2. **柔軟な表示**: 週/3日/1日の表示切り替え
3. **効率的な管理**: プロジェクト別、お気に入りタスク機能
4. **堅牢な設計**: エラーハンドリング、データ検証
5. **拡張性**: 新機能の追加が容易

ユーザーは複雑な操作を覚えることなく、直感的に作業時間を管理できるよう設計されています。
